name: Check Datadog Chart Version Changes

on:
  push:
    branches:
      - main
    paths:
      - 'charts/datadog/datadog-*/Chart.yaml'

jobs:
  check-version-change:
    name: Detect Datadog chart version changes
    runs-on: ubuntu-latest

    outputs:
      version-changed: ${{ steps.compare.outputs.version-changed }}
      changes: ${{ steps.compare.outputs.changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Compare Datadog dependency versions
        id: compare
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          CHANGED=false
          CHANGES="{}"

          # Get only Chart.yaml files changed in this push
          mapfile -t CHANGED_CHARTS < <(
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
              | grep '^charts/datadog-.*/Chart.yaml$' || true
          )

          if [[ ${#CHANGED_CHARTS[@]} -eq 0 ]]; then
            echo "No Datadog Chart.yaml files changed"
          fi

          for chart in "${CHANGED_CHARTS[@]}"; do
            env=$(basename "$(dirname "$chart")" | sed 's/datadog-//')

            CURRENT_VERSION=$(yq e -r '
              .dependencies[] | select(.name == "datadog") | .version
            ' "$chart" | tr -d '[:space:]')

            OLD_VERSION=$(git show "${{ github.event.before }}:$chart" 2>/dev/null \
              | yq e -r '
                  .dependencies[] | select(.name == "datadog") | .version
                ' - \
              | tr -d '[:space:]' || true)

            echo "[$env] old=$OLD_VERSION new=$CURRENT_VERSION"

            if [[ "$CURRENT_VERSION" != "$OLD_VERSION" ]]; then
              CHANGED=true
              CHANGES=$(jq \
                --arg env "$env" \
                --arg old "$OLD_VERSION" \
                --arg new "$CURRENT_VERSION" \
                '. + {($env): {old: $old, new: $new}}' \
                <<<"$CHANGES")
            fi
          done

          echo "version-changed=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "changes=$CHANGES" >> "$GITHUB_OUTPUT"



      - name: Debug output
        run: |
          echo "Version changed: ${{ steps.compare.outputs.version-changed }}"
          echo "Changes:"
          echo '${{ steps.compare.outputs.changes }}' | jq .
