name: Check Datadog Chart Version Changes

on:
  push:
    branches:
      - main
    paths:
      - 'charts/datadog/datadog-*/Chart.yaml'

jobs:
  check-version-change:
    name: Detect Datadog chart version changes
    runs-on: ubuntu-latest

    outputs:
      version-changed: ${{ steps.compare.outputs.version-changed }}
      changes: ${{ steps.compare.outputs.changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compare chart versions
        id: compare
        shell: bash
        run: |
          set -euo pipefail

          BEFORE_SHA="${{ github.event.before }}"
          CHANGED=false
          CHANGES="{}"

          for chart in charts/datadog/datadog-*/Chart.yaml; do
            env=$(basename "$(dirname "$chart")" | sed 's/datadog-//')

            CURRENT_VERSION=$(yq e '.version' "$chart")

            if git cat-file -e "$BEFORE_SHA:$chart" 2>/dev/null; then
              OLD_VERSION=$(git show "$BEFORE_SHA:$chart" | yq e '.version' -)
            else
              OLD_VERSION=""
            fi

            if [[ "$CURRENT_VERSION" != "$OLD_VERSION" ]]; then
              CHANGED=true
              CHANGES=$(jq \
                --arg env "$env" \
                --arg old "$OLD_VERSION" \
                --arg new "$CURRENT_VERSION" \
                '. + {($env): {old: $old, new: $new}}' \
                <<<"$CHANGES")
            fi
          done

          echo "version-changed=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "changes=$CHANGES" >> "$GITHUB_OUTPUT"

      - name: Debug output
        run: |
          echo "Version changed: ${{ steps.compare.outputs.version-changed }}"
          echo "Changes:"
          echo '${{ steps.compare.outputs.changes }}' | jq .
